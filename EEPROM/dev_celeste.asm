;;;
;;; 	CELESTE Board Console Driver
;;;

	INCLUDE	"./celeste.inc"

INIT:
	MVI	R0,X'00'
	ST	R0,SMBASE+CO_HSK
	ST	R0,SMBASE+CO_CMD ; Command

	MVI	R0,CG_SIG
	ST	R0,SMBASE+CO_SIG ; Signature

	MVI	R0,CH_REQ
	ST	R0,SMBASE+CO_HSK ; Handshake

	RET

CONIN:
	L	R0,SMBASE+CO_HSK
	MVI	R1,CH_REQ
	CB	R0,R1,NZ
	B	CONIN

	MVI	R0,CC_CIN
	ST	R0,SMBASE+CO_CMD

	ST	R1,SMBASE+CO_HSK
CIN0:
	L	R0,SMBASE+CO_HSK
	CB	R0,R1,NZ
	B	CIN0

	L	R0,SMBASE+CO_DAT
	ANDI	R0, X'00FF'
	
	RET

CONST:
	L	R0,SMBASE+CO_HSK
	MVI	R1,CH_REQ
	CB	R0,R1,NZ
	B	CONST

	MVI	R0,CC_CST	; CONST Command
	ST	R0,SMBASE+CO_CMD

	ST	R1,SMBASE+CO_HSK
CST0:
	L	R0,SMBASE+CO_HSK
	CB	R0,R1,NZ
	B	CST0

	L	R0,SMBASE+CO_DAT
	ANDI	R0, X'00FF'

	RET

CONOUT:
	PUSH	R0
COUT0:
	L	R0,SMBASE+CO_HSK
	MVI	R1,CH_REQ
	CB	R0,R1,NZ
	B	COUT0

	MVI	R0,CC_COT	; CONOUT Command
	ST	R0,SMBASE+CO_CMD

	POP	R0
	ST	R0,SMBASE+CO_DAT

	ST	R1,SMBASE+CO_HSK

	RET
